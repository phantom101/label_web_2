{% extends "base.jinja2" %}

{% block page_title %}{{ title }}{% endblock %}

{% block jumbotron %}
  <h1>Template File Print</h1>
  <p>Select your template and print it.</p>
  <!--<p><a class="btn btn-primary btn-lg" href="#" role="button">History of printed labels</a></p>-->
{% endblock %}

{% block content %}
    <div class="row">
        <!-- First Column: Template File Picker -->
        <div class="col-md-4">
            <fieldset class="form-group">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" href="#collapseTemplateFile" aria-expanded="true"
                               aria-controls="collapseTemplateFile">
                                <span class="glyphicon glyphicon-print"></span> Template File
                            </a>
                        </h4>
                    </div>
                    <div id="collapseTemplateFile" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <label for="template"> Template:</label>
                            <select class="form-control" id="template" onChange="onTemplateChange()">
                                <option value="">Select a template...</option>
                                {% for template in files %}
                                    <option value="{{ template }}">{{ template }}</option>{% endfor %}
                            </select>
                            <label for="printer"> Printer:</label>
                            <select class="form-control" id="printer" onChange="onPrinterChange()">
                                {% for printer in printers %}
                                    <option value="{{ printer }}"
                                            {% if label['DEFAULT_PRINTER'] == printer %}selected{% endif %}>{{ printer }}</option>
                                {% endfor %}
                            </select>
                            <label for="labelSize">Label Size:</label>
                            <select class="form-control" id="labelSize" onChange="onLabelSizeChange()">
                                {% for label_size in label_sizes.keys() %}<option value="{{label_size}}" {% if label['DEFAULT_SIZE'] == label_size %}selected{% endif %}>{{label_sizes[label_size]}}</option>{% endfor %}
                            </select>
                            <label for="quantity">Quantity:</label>
                            <input id="quantity" class="form-control" type="number" min="1" value="1" required>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

  <!-- Second Column: Template Data + Template Source Editor -->
  <div class="col-md-4">
    <fieldset class="form-group">

      <div class="panel panel-default" id="templateSourcePanel">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" href="#collapseTemplateSource" aria-expanded="true" aria-controls="collapseTemplateSource">
              <span class="glyphicon glyphicon-file"></span> Template Source (.lbl)
            </a>
          </h4>
        </div>
        <div id="collapseTemplateSource" class="panel-collapse collapse in">
          <div class="panel-body">
            <textarea id="templateSource" class="form-control" rows="12" style="font-family: monospace;" placeholder="Template source will appear here after selecting a template."></textarea>
            <div class="text-right" style="margin-top: 8px;">
              <button id="saveTemplateSourceButton" type="button" class="btn btn-sm btn-primary" onclick="saveTemplateSource()">
                <span class="glyphicon glyphicon-floppy-disk"></span> Save &amp; Preview
              </button>
            </div>
            <div id="templateSourceStatus" class="text-muted small" style="min-height: 1.2em;"></div>
          </div>
        </div>
      </div>


      <div class="panel panel-default" id="dynamicFieldsPanel">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" href="#collapseTemplateData" aria-expanded="true" aria-controls="collapseTemplateData">
              <span class="glyphicon glyphicon-edit"></span> Template Data
            </a>
          </h4>
        </div>
        <div id="collapseTemplateData" class="panel-collapse collapse in">
          <div class="panel-body">
            <div id="dynamicFields">
              <!-- Dynamic form fields will be inserted here -->
            </div>
          </div>
        </div>
      </div>


    </fieldset>
  </div>

  <!-- Third Column: Preview Image and Controls -->
  <div class="col-md-4">
    <fieldset class="form-group">
      <label for="previewImg">Label Preview:</label><br />
      <div id="previewWrapper" style="border: 1px solid #444; max-height: 350px; width: 100%; max-width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; background-color: #f8f8f8;">
        <div id="previewPlaceholder" class="text-muted small">Please select label</div>
        <img id="previewImg" alt="Label preview" style="display: none; max-height: 350px; width: auto; max-width: 100%;"/>
      </div>
      <div id="previewStatus" class="text-muted small" style="min-height: 1.2em;"></div>
      <p>Printed size w/o margins: <span id="labelWidth">?</span> cm x <span id="labelHeight">?</span> cm</p>
      <button id="printButton" type="button" class="btn btn-primary btn-block btn-lg" onClick="print()" disabled>
        <span class="glyphicon glyphicon-print" aria-hidden="true"></span> Print
      </button>
    </fieldset>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><span class="glyphicon glyphicon-console" aria-hidden="true" style="margin-right: 0.3em"></span> Status</h3>
      </div>
      <div id="statusPanel" class="panel-body">
        - undefined -
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}

var currentTemplateFields = [];

/**
 * Callback function to update preview after media is loaded
 */
function onMediaLoaded(data) {
  // Update preview with new media if a template is selected
  if ($('#template').val()) {
    preview();
  }
}

function onPrinterChange() {
  var printerName = $('#printer').val();
  // Load media for the selected printer
  loadPrinterMedia(printerName, onMediaLoaded);
}

function onLabelSizeChange() {
  // Update preview when label size changes
  if ($('#template').val()) {
    preview();
  }
}

function formData() {
  var data = {
    quantity: parseInt($('#quantity').val()) || 1
  };

  // Add dynamic field values
  currentTemplateFields.forEach(function(field) {
    var value = $('#field_' + field.name).val();
    // Always submit required fields, even if empty
    if(field.required) {
      data[field.name] = value !== undefined && value !== null ? value : '';
    } else if (value) {
      data[field.name] = value;
    }
  });

  return data;
}

function updatePrintButtonState() {
  var allRequiredFieldsFilled = true;

  currentTemplateFields.forEach(function(field) {
    if (field.required) {
      var value = $('#field_' + field.name).val();
      if (!value || value.trim() === '') {
        allRequiredFieldsFilled = false;
      }
    }
  });

  $('#printButton').prop('disabled', !allRequiredFieldsFilled);
}

// Consolidate all manual printButton state updates to use updatePrintButtonState
function onTemplateChange() {
  var templateName = $('#template').val();
  if (!templateName) {
    // No template selected: reset preview to initial state
    $('#previewImg').hide().attr('src', '');
    $('#previewPlaceholder').text('Please select label').show();
    $('#previewStatus').text('');
    $('#templateSource').val('');
    $('#templateSourceStatus').text('');
    updatePrintButtonState();
    return;
  }

  loadTemplateFields(templateName);
  loadTemplateSource(templateName);
  // Don't call preview() here - it will be called after fields are loaded
}

function loadTemplateFields(templateName) {
  $.ajax({
    url: '/api/template/' + templateName + '/fields',
    type: 'GET',
    dataType: 'json',
    success: function(response) {
      currentTemplateFields = response.fields || [];
      generateDynamicFields(currentTemplateFields);
      updatePrintButtonState();
      // Call preview() after fields are successfully loaded
      preview();
    },
    error: function(xhr, status, error) {
      console.error('Error loading template fields:', error);
      currentTemplateFields = [];
      updatePrintButtonState();
      // Still try to load preview even if fields loading fails
      preview();
    }
  });
}

function loadTemplateSource(templateName) {
  if (!templateName) return;

  $('#templateSourceStatus').text('Loading template source...');
  $.ajax({
    url: '/api/template/' + templateName + '/raw',
    type: 'GET',
    dataType: 'text',
    success: function(data) {
      $('#templateSource').val(data);
      $('#templateSourceStatus').text('');
    },
    error: function(xhr, status, error) {
      console.error('Error loading template source:', error);
      $('#templateSource').val('');
      $('#templateSourceStatus').text('Error loading template source');
    }
  });
}

function generateDynamicFields(fields) {
  var fieldsContainer = $('#dynamicFields');
  fieldsContainer.empty();

  if (fields.length === 0) {
    updatePrintButtonState();
    return;
  }

  fields.forEach(function(field) {
    // Create form group container
    var formGroup = $('<div>').addClass('form-group');

    // Create label with escaped text
    var label = $('<label>')
      .attr('for', 'field_' + field.name)
      .text(field.label);

    if (field.required) {
      label.append(' ').append($('<span>').addClass('text-danger').text('*'));
    }
    label.append(':');
    formGroup.append(label);

    // Create input or textarea
    var inputType = field.type || 'text';
    var placeholder = field.placeholder || '';
    var input;

    if (inputType === 'textarea') {
      input = $('<textarea>')
        .addClass('form-control')
        .attr('id', 'field_' + field.name)
        .attr('name', field.name)
        .attr('placeholder', placeholder)
        .on('change', onFieldChange)
        .on('keyup', onFieldChange);
    } else {
      input = $('<input>')
        .attr('type', inputType)
        .addClass('form-control')
        .attr('id', 'field_' + field.name)
        .attr('name', field.name)
        .attr('placeholder', placeholder)
        .on('change', onFieldChange)
        .on('keyup', onFieldChange);
    }

    if (field.required) {
      input.prop('required', true);
    }

    formGroup.append(input);

    // Add description if present
    if (field.description) {
      var description = $('<small>')
        .addClass('form-text text-muted')
        .text(field.description);
      formGroup.append(description);
    }

    fieldsContainer.append(formGroup);
  });

  // Enable/disable print button based on required fields
  updatePrintButtonState();
}

function onFieldChange() {
  updatePrintButtonState();
  // Update preview when fields change
  clearTimeout(window.previewTimeout);
  window.previewTimeout = setTimeout(preview, 300); // Debounce preview updates
}

function buildRequestData(includeFields) {
  /**
   * Build request data by separating regular form data from JSON payload fields.
   * @param {Object} includeFields - Additional fields to include in regularData (e.g., {quantity: 1, printer: 'main'})
   * @returns {Object} Object containing regularData and jsonPayload
   */
  var regularData = {};
  var jsonPayload = {};
  var formDataObj = formData();

  // Process template fields
  currentTemplateFields.forEach(function(field) {
    var value = $('#field_' + field.name).val();
    // Always submit required fields, even if empty
    if (field.required) {
      var fieldValue = value !== undefined && value !== null ? value : '';
      if (field.json_payload) {
        jsonPayload[field.name] = fieldValue;
      } else {
        regularData[field.name] = fieldValue;
      }
    } else if (value) {
      // Only submit non-required fields if they have a value
      if (field.json_payload) {
        jsonPayload[field.name] = value;
      } else {
        regularData[field.name] = value;
      }
    }
  });

  // Add additional fields to regular data
  if (includeFields) {
    for (var key in includeFields) {
      regularData[key] = includeFields[key];
    }
  }

  // Always include label size
  regularData['label_size'] = $('#labelSize').val();

  return {
    regularData: regularData,
    jsonPayload: jsonPayload
  };
}

function buildUrlWithParams(baseUrl, params) {
  /**
   * Build URL with query parameters.
   * @param {string} baseUrl - The base URL
   * @param {Object} params - Parameters to add as query string
   * @returns {string} URL with query parameters
   */
  var queryParams = [];
  for (var key in params) {
    queryParams.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
  }

  if (queryParams.length > 0) {
    return baseUrl + '?' + queryParams.join('&');
  }
  return baseUrl;
}

function saveTemplateSource() {
  var templateName = $('#template').val();
  if (!templateName) {
    $('#templateSourceStatus').text('Please select a template first.');
    return;
  }

  var content = $('#templateSource').val();
  $('#templateSourceStatus').text('Saving template...');

  $.ajax({
    url: '/api/template/' + templateName + '/raw',
    type: 'POST',
    data: content,
    contentType: 'text/plain; charset=utf-8',
    success: function(data) {
      $('#templateSourceStatus').text('Template saved. Regenerating preview...');
      // After saving, reload fields (in case structure changed) and preview
      loadTemplateFields(templateName);
      // loadTemplateFields will call preview() once fields are loaded
    },
    error: function(xhr, status, error) {
      console.error('Error saving template source:', error);
      $('#templateSourceStatus').text('Error saving template source');
    }
  });
}

function preview() {
  var templateName = $('#template').val();
  if (!templateName) return;

  var formDataObj = formData();
  var baseUrl = '/api/preview/template/' + templateName;

  // Build request data
  var requestData = buildRequestData({
    quantity: formDataObj.quantity
  });

  // Build URL with query parameters
  var url = buildUrlWithParams(baseUrl, requestData.regularData);

  // Show loading status while preview is being generated
  $('#previewStatus').text('Generating preview...');
  // Show placeholder box and hide the actual image while loading
  $('#previewPlaceholder').text('Generating preview...').show();
  $('#previewImg').hide().attr('src', '');

  // Use POST request with JSON payload
  $.ajax({
    url: url,
    type: 'POST',
    data: JSON.stringify(requestData.jsonPayload),
    contentType: 'application/json',
    xhrFields: {
      responseType: 'blob'
    },
    success: function(imageData) {
      var imageUrl = URL.createObjectURL(imageData);
      $('#previewImg').attr('src', imageUrl);
      var img = $('#previewImg')[0];
      img.onload = function() {
        $('#labelWidth').html((img.naturalWidth / 300 * 2.54).toFixed(1));
        $('#labelHeight').html((img.naturalHeight / 300 * 2.54).toFixed(1));
        URL.revokeObjectURL(imageUrl);
        // Hide placeholder and show the loaded image
        $('#previewPlaceholder').hide();
        $('#previewImg').show();
        $('#previewStatus').text('');
      };
    },
    error: function(xhr, status, error) {
      console.error('Error loading preview:', error);
      // On error, keep showing the placeholder and hide the image
      $('#previewImg').hide().attr('src', '');
      $('#previewPlaceholder').text('Error loading preview').show();
      $('#previewStatus').text('Error loading preview');
    }
  });
}

function setStatus(data) {
  if (data['success']) {
    $('#statusPanel').html('<div id="statusBox" class="alert alert-success" role="alert"><i class="glyphicon glyphicon-check"></i><span>Printing was successful.</span></div>');
  } else if (data['has_config_errors']) {
    $('#statusPanel').html('<div id="statusBox" class="alert alert-danger" role="alert"><i class="glyphicon glyphicon-alert"></i><span>Cannot print: Configuration errors exist. Please <a href="/settings">resolve them in settings</a>.</span></div>');
  } else {
    // Escape the error message to prevent XSS
    var escapedMessage = escapeHtml(data['message'] || data['error'] || 'Unknown error');
    $('#statusPanel').html('<div id="statusBox" class="alert alert-warning" role="alert"><i class="glyphicon glyphicon-alert"></i><span>Printing was unsuccessful:<br />' + escapedMessage + '</span></div>');
  }
  // Only update print button state via updatePrintButtonState
  updatePrintButtonState(); // Restore proper button state
}

function print() {
  $('#printButton').prop('disabled', true);
  $('#statusPanel').html('<div id="statusBox" class="alert alert-info" role="alert"><i class="glyphicon glyphicon-hourglass"></i><span>Processing print request...</span></div>');

  var templateName = $('#template').val();
  var formDataObj = formData();
  var baseUrl = '/api/print/template/' + templateName;

  // Build request data
  var requestData = buildRequestData({
    quantity: formDataObj.quantity,
    printer: $('#printer').val()
  });

  // Build URL with query parameters
  var url = buildUrlWithParams(baseUrl, requestData.regularData);

  // Use POST request with JSON payload
  $.ajax({
    url: url,
    type: 'POST',
    data: JSON.stringify(requestData.jsonPayload),
    contentType: 'application/json',
    dataType: 'json',
    success: setStatus,
    error: setStatus
  });
}

// Load media for the initially selected printer on page load
$(document).ready(function() {
  var initialPrinter = $('#printer').val();
  if (initialPrinter) {
    loadPrinterMedia(initialPrinter, onMediaLoaded);
  }
});

{% endblock %}